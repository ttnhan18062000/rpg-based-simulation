# Epic 05: Advanced Combat Mechanics

## Summary

Deepen the combat system with positioning tactics, aggro management, AoE attacks, combo chains, environmental interactions, and status ailments. Combat becomes a richer tactical experience where entity positioning, skill order, and terrain matter.

Inspired by: Final Fantasy Tactics positioning, Dark Souls stamina management, D&D opportunity attacks, Divinity: Original Sin environmental combos.

---

## Motivation

- Current combat is 1v1 melee exchanges with potions — lacks tactical depth
- No AoE damage, no positioning strategy, no environmental interaction
- Engagement lock exists but could be expanded into a full positioning system
- Skills exist but lack combo potential or synergy between damage types/elements
- Aligns with "realistic RPG simulation" — real combat involves terrain, positioning, and teamwork

---

## Features

### F1: AoE Attacks & Skills
- Skills with `AREA_ENEMIES` / `AREA_ALLIES` target types affect multiple entities in a radius
- AoE skills have a `radius` field (Manhattan distance from center)
- AoE damage reduced by distance from center (configurable falloff)
- Friendly fire rules: AoE from hostile factions damages all non-allied entities in range
- **Extensibility:** AoE defined per `SkillDef` — no special-case code for individual skills

### F2: Combo System
- Applying elemental damage to an entity with certain status effects triggers a combo
- Example combos:
  - Wet (rain/water) + Lightning → **Electrocute** (2× damage, AoE stun)
  - Poison + Fire → **Toxic Explosion** (AoE damage)
  - Frozen (ice) + Physical → **Shatter** (bonus crit damage)
- Combos defined in a `COMBO_REGISTRY` dict: `(existing_effect, incoming_element) → ComboResult`
- **Extensibility:** New combos = new registry entries, not code changes

### F3: Aggro & Threat System
- Each enemy tracks a `threat_table: dict[int, float]` mapping attacker IDs to threat scores
- Threat generated by: damage dealt, healing allies, using buff skills, proximity
- Enemies attack the highest-threat target (not just nearest)
- Tank classes generate bonus threat (Warrior's Battle Cry adds AoE threat)
- Threat decays over time if no interaction
- **Extensibility:** Threat multipliers defined per skill and per class, not hard-coded

### F4: Ranged Combat Positioning
- Ranged attacks (bows, magic staves, ranged skills) can hit targets at distance > 1
- Ranged entities prefer to maintain optimal distance (kiting behavior)
- Line-of-sight checks: ranged attacks blocked by WALL tiles between attacker and defender
- Cover system: entities behind partial cover (adjacent to WALL) get evasion bonus
- **Extensibility:** Weapon `range` field already implied by some skills; extend to all weapons

### F5: Environmental Combat
- Certain tiles affect combat:
  - WATER tiles: entities standing in water are Wet (vulnerable to lightning)
  - LAVA tiles: proximity damage (already impassable, but could have adjacent heat damage)
  - FOREST tiles: provide cover bonus (+10% evasion for defenders)
  - MOUNTAIN tiles: high ground bonus (+5% ATK for entities on mountain attacking lower ground)
- **Extensibility:** Terrain combat modifiers defined in a `TERRAIN_COMBAT_MODS` registry

### F6: Status Ailments Expansion
- New ailment types using the existing `StatusEffect` system:
  - **Stun** — skip next action (SPD mult = 0 for duration)
  - **Blind** — reduce accuracy (ATK mult reduced)
  - **Silence** — cannot use skills (only basic attacks)
  - **Burn** — fire DoT + reduced DEF
  - **Frozen** — reduced SPD + increased physical vulnerability
  - **Wet** — increased lightning vulnerability
- Each ailment has a resistance check based on defender's stats
- **Extensibility:** New ailments = new `EffectType` + factory function

### F7: Combat Formations
- When multiple allied entities are adjacent, formation bonuses apply:
  - **Line formation** (3+ in a row): +10% ATK
  - **Shield wall** (2+ adjacent with armor): +15% DEF
  - **Flanking** (2 allies on opposite sides of enemy): +20% crit rate
- Formation detection runs during conflict resolution
- **Extensibility:** Formations defined as pattern-matching rules in a registry

---

## Design Principles

- All new combat mechanics flow through the existing `CombatAction.apply()` pipeline
- Status ailments use the existing `StatusEffect` system
- AoE and ranged attacks use the existing `ActionProposal` → `WorldLoop` pipeline
- Environmental effects are data-driven via terrain modifier registries
- Combo system is a pure lookup table — no complex interaction code
- All combat remains fully deterministic via `Domain.COMBAT` RNG

---

## Dependencies

- Skill system with target types (already exists)
- Status effect system (already exists)
- Damage type + element system (already exists)
- Engagement lock mechanic (already exists)
- Territory/terrain system (already exists)

---

## Estimated Scope

- Backend: ~10 files modified
- Frontend: ~3 files modified (combat animations, effect indicators)
- Data: Combo registry, terrain combat mods, new ailment definitions

---

## Dev Notes (from dev_noted_features)

> **[EPIC] combat? ranged combat?**

F4 (Ranged Combat Positioning) is the highest-priority feature from this epic per developer request. Consider implementing F4 as a standalone deliverable before the full epic.
